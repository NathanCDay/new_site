---
title: Drug crime spatial analysis with library(sf)
author: Nate Day
date: '2017-12-18'
slug: drug-crime-analysis-with-library-sf
categories:
  - Cville Open Data
tags:
  - geocode
  - sf
  - spatial
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/blazy/blazy.min.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>


<div id="intro" class="section level2">
<h2>Intro</h2>
<p>This post is focused on using the new R 📦 <a href="https://cran.r-project.org/web/packages/sf/sf.pdf"><code>library(sf)</code></a> and the <a href="http://opendata.charlottesville.org/datasets/crime-data">Charlottesville (VA) Police Department’s Crime Reports dataset</a> to locate drug activity hotspots in the city. This markdown uses tehniques discussed and data dervied from my earlier posts with the <a href="/categories/cville-open-data">Cville Open Data Tag</a>.</p>
<p>The biggest reason I am excited about <code>library(sf)</code> is its new <code>sf</code> objects, which are extended dataframes with a specialized list column for storing simple features. <a href="https://en.wikipedia.org/wiki/Simple_Features">Simple features</a> is an ISO approved standardized format for representing two dimensional geometries, ie points, lines and polygons. <code>library(sf)</code> functions automatically use this list column when available, leaving all of the other columns for associated variables. This is means working with my favorite <code>tidyverse</code> tools to wrangle and summarize data are now just one <code>%&gt;%</code> away.</p>
<p>All of the data used here is available either directly from the portal itself or my <a href="https://github.com/NathanCDay/cville_crime">Github repo</a>. If you like this stuff, I’m leading a Smart Cville Data Dive event on February 7th, and you should totally come.</p>
<pre class="r"><code># the library ---------------------------------------------------------------
library(sf) # tools for simple features
library(geojsonio) # API access
library(viridis) # pretty colors
library(leaflet) # ineteractive maps
library(cowplot) # grid ggplots
library(tidyverse) # always
library(magrittr) # %&lt;&gt;% life

theme_set(theme_void())</code></pre>
</div>
<div id="data-in" class="section level2">
<h2>Data In</h2>
<p>The first piece of data we need is the geo-coded crime dataset from my <a href="/posts/drug-crime-analysis-with-library-sf.html">last post</a>. Since the published version of the crime data doesn’t include any geo-spatial information, Google Maps and I went ahead and tagged most of the records with longitude and latitude coordinates.</p>
<pre class="r"><code>crime &lt;- read_csv(&quot;https://raw.githubusercontent.com/NathanCDay/cville_crime/master/crime_geocode.csv&quot;)
crime %&lt;&gt;% filter(complete.cases(crime)) # not all of the records could be geo-coded
names(crime) %&lt;&gt;% tolower() # easy typing

# flag drug related offense tags
crime %&lt;&gt;% mutate(drug_flag = ifelse(grepl(&quot;drug&quot;, offense, ignore.case = TRUE),
                                     &quot;drugs&quot;, &quot;not_drugs&quot;))</code></pre>
<p>Geo-coding is messy business and so is manual data entry. When I originally geocoded the crime dataset, I wanted to balance the ammount of manual manipulation with location accuracy. So I made minimal changes to the raw address values and allowed some obvious typos and cases of mistaken location to slip through in an effort to keep the dataset as stock as possible. But in this markdown we will do a little bit more filtering to clean up.</p>
<p>We will use the <a href="http://opendata.charlottesville.org/datasets/us-census-block-group-area-2010">2010 US Census Block Group Area data</a> for Charlottesville, Virginia, to do some spatial filtering. This data is available on the ODP in a variety of formats but we will use the great <code>library(geojsonio)</code>, which <a href="/posts/">I wrote about here</a>, the ODP’s API to read it in and minimize headaches.</p>
<pre class="r"><code>census &lt;- geojson_read(&quot;https://opendata.arcgis.com/datasets/e60c072dbb734454a849d21d3814cc5a_14.geojson&quot;,
                       what = &quot;sp&quot;) # a list object
census %&lt;&gt;% st_as_sf() # convert to simple features data frame
names(census) %&lt;&gt;% tolower() # easy typing

# keep only the housing and population related variables
census %&lt;&gt;% select(geometry, starts_with(&quot;h&quot;), objectid:other) </code></pre>
<p>We are keeping certain columes to give use some demographic and housing data along with the mapping areas.</p>
</div>
<div id="spatial-fitler" class="section level2">
<h2>Spatial fitler</h2>
<p>In spatial analysis, coordinate referense systems (CRS) are everything. In order to do any type of measurements, identical CRSs are required. Since the census data is downloaded as geoJSON data, it already has a CRS associated with it, but the crime data does not. Fortunatly <code>df::st_crs</code> and <code>df::st_as_sf</code> make this transformation simple.</p>
<pre class="r"><code>st_crs(census) # checks crs of an object, returns list</code></pre>
<pre><code>## $epsg
## [1] 4326
## 
## $proj4string
## [1] &quot;+proj=longlat +datum=WGS84 +no_defs&quot;
## 
## attr(,&quot;class&quot;)
## [1] &quot;crs&quot;</code></pre>
<pre class="r"><code>crs_val &lt;- st_crs(census, asText = TRUE) # returns chr string, convienent for use later

# tranform crime to simple features data frame
crime %&lt;&gt;% st_as_sf(coords = c(&quot;lon&quot;, &quot;lat&quot;), # define geo-spatial variables
                    crs = crs_val) # set CRS to match census</code></pre>
<p>To apply our spatial filter we can use good our good ol’ <code>dplyr</code> friends <code>mutate()</code> and <code>filter()</code> paired with <code>sf::st_within()</code>, which is one of several useful functions for computing predicates on pairs of simple feature geometries.</p>
<pre class="r"><code># add a new column to show which census block group each point resides in
crime %&lt;&gt;% mutate(within = st_within(crime, census) %&gt;% # returns a list by default
                      as.numeric()) # convert to numeric for mutate()

# remove rows with NAs, because they&#39;re outside of the city
crime %&lt;&gt;% filter(!is.na(within))</code></pre>
</div>
<div id="sptial-viz" class="section level2">
<h2>Sptial viz</h2>
<p>Now that we’ve pruned down to only the crimes reported within the city limits. We can use the new <code>ggplot2::geom_sf()</code>, to plot it. Right now this <code>geom</code> is only in the development version so to use it you need to install directly from GitHub via <code>devtools::install_github(&quot;tidyverse/devtools&quot;)</code>. Lets use some more tidyverse magic to make a summary plot by address (remeber this data is is only coded to the hundred block), comparing the frequent locations for drug crime compared to all other crimes.</p>
<pre class="r"><code>address_summary &lt;- group_by(crime, address) %&gt;%
    summarise(drug_crime = sum(drug_flag == &quot;drugs&quot;),
              other_crime = sum(drug_flag != &quot;drugs&quot;)) %&gt;%
    gather(type, number, contains(&quot;crime&quot;))

ggplot(census) +
    geom_sf() +
    geom_sf(data = address_summary,
            aes(size = number, color = number, alpha = number)) +
    scale_color_viridis() +
    scale_size_area(max_size = 10) +
    facet_grid(~type)</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/plot_size-1.png" width="672" /></p>
<p>It looks like there is a concentration of crime in the downtown area, which makes sense since becasue crime rates are typically proportional to population/business density. However one address downtown stands out as much more frequent that the rest, let’s investigate what’s going on there.</p>
<pre class="r"><code>arrange(address_summary, -number) %&gt;% head() # 600 E Market St</code></pre>
<pre><code>## Simple feature collection with 6 features and 3 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -78.50007 ymin: 38.01713 xmax: -78.47746 ymax: 38.05137
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
## # A tibble: 6 x 4
##                               address        type number          geometry
##                                 &lt;chr&gt;       &lt;chr&gt;  &lt;int&gt;  &lt;simple_feature&gt;
## 1  600 E MARKET ST Charlottesville VA other_crime    635 &lt;POINT (-78.4...&gt;
## 2 700 PROSPECT AVE Charlottesville VA other_crime    412 &lt;POINT (-78.4...&gt;
## 3  600 E MARKET ST Charlottesville VA  drug_crime    410 &lt;POINT (-78.4...&gt;
## 4   1100 5TH ST SW Charlottesville VA other_crime    341 &lt;POINT (-78.4...&gt;
## 5  1100 EMMET ST N Charlottesville VA other_crime    307 &lt;POINT (-78.5...&gt;
## 6   400 GARRETT ST Charlottesville VA other_crime    303 &lt;POINT (-78.4...&gt;</code></pre>
<pre class="r"><code># the police station is at 606 E Market St</code></pre>
<p>Something is going on there, when the same block as the police station has the most reported cases for both drug crime and all other crimes. Perhaps it has something to do with the departments reporting practices, but this is definately not the city block with the most criminal activity. Let look at the proportion of drug and other crime reported at 600 E Market.</p>
<pre class="r"><code>station_props &lt;- arrange(address_summary, -number) %&gt;%
    group_by(type) %&gt;%
    add_count(wt = number) %&gt;%
    slice(1)

summarise(station_props, prop_total = number / n)</code></pre>
<pre><code>## # A tibble: 2 x 2
##          type prop_total
##         &lt;chr&gt;      &lt;dbl&gt;
## 1  drug_crime 0.22198159
## 2 other_crime 0.02175626</code></pre>
<pre class="r"><code>with(station_props, prop.test(number, n))</code></pre>
<pre><code>## 
##  2-sample test for equality of proportions with continuity
##  correction
## 
## data:  number out of n
## X-squared = 2134, df = 1, p-value &lt; 2.2e-16
## alternative hypothesis: two.sided
## 95 percent confidence interval:
##  0.1809112 0.2195395
## sample estimates:
##     prop 1     prop 2 
## 0.22198159 0.02175626</code></pre>
<p>The relative proportion of drug crime reported at the police station is much higher than other crimes. This statistically significant difference needs to be investigated more. Recent pushes for more transparent policing have used cell-phone and body-camera videos to capture incidents, but data analysis can also play the same role by identifiying irregular patterns.</p>
<p>The Murder Accountability Project (MAP), a crime-anlysis non-profit, is an example of this data intiative. Founded by an investiagtive reported and retired homicide detective, their alogrithmic murder suvurvaillance, was featuerd on <a href="https://news.vice.com/en_us/article/5955vd/is-there-a-serial-killer-roaming-the-streets-of-chicago">Vice News</a> for their “red alert” flagging for an active serial killer in Chicago Illinois. Chicago’s string of stranglation/asphixiation muders with female victims is the second most suspicious in the country, Cleveland, Ohio has an even scarier pattern. Both cities are believed to be the work of one or more active killers. You can see the MAP’s <a href="http://www.murderdata.org/p/clusters-by-county.html">alorithim at work on this nation-wide map tool</a>.</p>
</div>
<div id="hot-spots" class="section level2">
<h2>Hot spots</h2>
<p>Crime events tend to cluster and police departments already know this. Typically the most crime is found in the most urban areas; the places with the largest populations and the densest targets. Becasue of this using just total counts to find areas of of high criminal acivity, is not particularly useful without a normalization factor. Since we are really interested in areas with more drug crime than average, we can use the total number of crimes reported , to control for areas with high overall crime. Using the Census block group areas, for our grouping regions, use <code>dplyr::summarise()</code> to calculate some useful stats.</p>
<pre class="r"><code># drop the police station to look at spatial trends in the community
crime %&lt;&gt;% filter(address != &quot;600 E MARKET ST Charlottesville VA&quot;)

# summarise counts by census block
crime_sum &lt;- st_set_geometry(crime, NULL) %&gt;% # need to remove geometry property
    group_by(within, drug_flag) %&gt;%
    count() %&gt;%
    spread(drug_flag, n) %&gt;% rowwise() %&gt;%
    mutate(total = sum(drugs, not_drugs),
           frac_drugs = drugs / total)

# join rate info into census
census %&lt;&gt;% inner_join(crime_sum, by = c(&quot;objectid&quot; = &quot;within&quot;))</code></pre>
<p>Now that we have our count data summarrized, let’s plot it, three different ways. Looking at the number of total crime crime reports, total drug crime reports and the fraction of drug crime reports in each census block group:</p>
<pre class="r"><code>plot_list &lt;- list()

plot_list[[&quot;total&quot;]] &lt;- ggplot(census) +
    geom_sf(aes(fill = total)) +
    scale_fill_viridis()

plot_list[[&quot;drugs&quot;]] &lt;- ggplot(census) +
    geom_sf(aes(fill = drugs)) +
    scale_fill_viridis()

plot_list[[&quot;frac&quot;]] &lt;- ggplot(census) +
    geom_sf(aes(fill = frac_drugs)) +
    scale_fill_viridis()

cowplot::plot_grid(cowplot::plot_grid(plotlist = plot_list[1:2]), plot_list[[3]], nrow = 2)</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/fig-1.png" width="672" /></p>
<p>The total reports and total drug reports plots show samilar stories, with the downtown mall area being the most frequent census block for reports. This makes sense but it’s particularly useful metric. Using the fraction of crime reports, show highlights two census block groups with almost 10% of the crimes reportted being drug crimes. In order to get a better idea of what streets are included in each census block, we can replot the last “frac_drugs” plot as an interactive <code>leaflet</code>.</p>
<pre class="r"><code>library(leaflet)

fill_pal &lt;- pal &lt;- colorNumeric(&quot;viridis&quot;, domain = census$frac_drugs)

leaflet(census) %&gt;%
    addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
    addPolygons(color = ~fill_pal(frac_drugs)) %&gt;%
    widgetframe::frameWidget(height = &#39;400&#39;) # containerizes widgets so CSS properties don&#39;t interfer with page CSS</code></pre>
<div id="htmlwidget-1" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html//widgets/widget_unnamed-chunk-4.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>The two census block groups with the highest proportions of drug crime, are located along Cherry Avenue and 5th Street SW. This area is home to two of Charlottesville’s Section 9 housing developments and both are some of the lowest income areas in the city. I have a follow up post planned for using <a href="https://www.census.gov/programs-surveys/acs/">American Community Survey data</a> to analyze income and unemployment statistics as they relate to drug crime. Discovering community risk factors is critical to combatting crime and creating safer communities.</p>
</div>
<div id="custom-shape-summarries" class="section level2">
<h2>Custom shape summarries</h2>
<p>Suppose we want to get an idea of hotspots on a smaller scale. Instead of using the census block areas, we can construct a grid of our own and apply the same process to summarise the crimes within these new areas. Making the grid is easy with <code>sf::st_make_grid()</code>.</p>
<pre class="r"><code>grd &lt;- st_make_grid(census, n = 50) %&gt;% st_sf() # 50x50 evenly sized squares

grd %&lt;&gt;% st_intersection(st_geometry(st_union(census))) # filter to those in census</code></pre>
<p>The inital grid fills the entire bounding box, the smallest rectangle that encompases the entire census map, so the second line of code just removes an areas of the grid that don’t intersect with the area censsu areas (ie the corners). This fuction will reduce grid squares that partially overlap with census blocks to just the overlapping polygon fragment.</p>
<p>Next we just need to caluculate the number of points within each grid unit, and summarise them by drug related and total reports like we did before.</p>
<pre class="r"><code>crime$grd &lt;- st_within(crime, grd) %&gt;% as.numeric()

grd_sum &lt;- st_set_geometry(crime, NULL) %&gt;% # need to remove geometry property
    group_by(grd, drug_flag) %&gt;%
    count() %&gt;%
    spread(drug_flag, n) %&gt;% rowwise() %&gt;%
    mutate(total = sum(drugs, not_drugs),
           frac_drugs = drugs / total)

# join sumamry stats back into grd
grd %&lt;&gt;% set_names(&quot;geometry&quot;) %&gt;% # sf functions look for geometry column
    mutate(grd = 1:nrow(.)) %&gt;% # make a key to match back on
    full_join(grd_sum)

# some areas don&#39;t have drug related crime, recode from NA to 0
grd$frac_drugs %&lt;&gt;% ifelse(is.na(.), 0, .)</code></pre>
<p>We did a little extra processing here than earlier, because as we moved to smaller summary areas, we introduced more areas without data (no crime reports). To imporove our visualiation, recoding the missing values to zeros, removes the use of an NA fill color (default is grey) in our plot.</p>
<pre class="r"><code>grd_pal &lt;- pal &lt;- colorNumeric(&quot;viridis&quot;, domain = grd$frac_drugs) # important to rescale

leaflet(grd) %&gt;%
    addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
    addPolygons(data = census, fill = NA, color = &quot;black&quot;, weight = 1) %&gt;%
    addPolygons(color = ~grd_pal(frac_drugs), stroke = FALSE, opacity = .9,
                popup = ~paste0(&quot;drugs: &quot;, drugs, &quot;&lt;br&gt;&quot;,
                                &quot;total: &quot;, total)) %&gt;%
    widgetframe::frameWidget(height = &#39;400&#39;)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"url":"/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html//widgets/widget_leaf_frac.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>Most of the highlighted hotspots have very low numbers of total crime reports, making their fraction of drug related offenses much higher than other higher crime areas. While it might be interested to look at these low total high proportional areas, this isn’t going to help us discrover areas of the city that have the most drug crime.</p>
<p>Let’s remake the plot above but instead of using the fraction of drug related crime, go back to using just total drug reports.</p>
<pre class="r"><code>grd$drugs %&lt;&gt;% ifelse(is.na(.), 0, .) # recode zeros
grd_pal &lt;- colorBin(&quot;viridis&quot;, n = 5, domain = grd$drugs) # important to rescale

leaflet(grd) %&gt;%
    addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
    addPolygons(data = census, fill = NA, color = &quot;black&quot;, weight = 1) %&gt;%
    addPolygons(color = ~grd_pal(drugs), stroke = FALSE, opacity = .9,
                popup = ~paste0(&quot;drugs: &quot;, drugs, &quot;&lt;br&gt;&quot;,
                                &quot;total: &quot;, total)) %&gt;%
    widgetframe::frameWidget(height = &#39;400&#39;)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"url":"/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html//widgets/widget_leaf_drugs.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>This shows some different hot spots the. Two major hot squares near the downtown mall, one on 4th St near Garret Square and the other on 1st St near Emancipation Park. The third hottest grid square, is between Tonsler Park and Forrest Hills. Analysis like this is useful for identifying areas like the Tonsler Park hotspot that are away from the most urban sections of the city and may represent some specific neighborhood trend. Like the hot square in the north central that is the right over Charlottesville High School.</p>
<p>If you liked reading this, please come out to the Smart Cville meetup in February, where we will code our way through parts of this and other spatial statistics. I would love to get community feedback on this project and other ideas where data can make a positive impact on Cville. Just drop me a line by email or on Github, cheers!</p>
</div>
