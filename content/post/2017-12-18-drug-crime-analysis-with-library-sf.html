---
title: Spatial anlysis of drug crime
author: Nate Day
date: '2017-12-18'
description: "Using library(sf) to visualize the spatial distribution of drug related crimes in Chalotteville"
slug: drug-crime-analysis-with-library-sf
categories:
  - Cville Open Data
tags:
  - geocode
  - sf
  - spatial
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/blazy/blazy.min.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>


<div id="intro" class="section level2">
<h2>Intro</h2>
<p>Historically working with spatial data in <code>R</code> revolved around using <code>library(sp)</code>and its special <code>S4</code> classes, like “SpatialPolygonsDataFrame”. The biggest reason I am excited to transition to <code>library(sf)</code> is its new <code>sf</code> objects, which are extended dataframes with a specialized list column for storing spatial geometries as simple features. This reimagined data structure means using with my favorite <code>tidyverse</code> tools on <code>sf</code> objects are now just one little <code>%&gt;%</code> away.</p>
<p>All of the data used here is originally sourced from the <a href="http://opendata.charlottesville.org/">Charlottesville Open Data Portal</a>. A geocoded version of the Police Reports is discussed in an earlier post and is available as a csv on <a href="https://github.com/NathanCDay/cville_crime">my Github repo here</a>. If you like this stuff, I’m helping with a Smart Cville Crime Data Deep Dive event on February 7th, and you should totally come.</p>
<pre class="r"><code># the library ---------------------------------------------------------------
library(sf) # tools for simple features
library(geojsonio) # API access
library(viridis) # pretty colors
library(leaflet) # ineteractive maps
library(cowplot) # grid ggplots
library(tidyverse) # always
library(magrittr) # %&lt;&gt;% life

theme_set(theme_void() +
              theme(panel.grid = element_blank()))</code></pre>
</div>
<div id="data-in" class="section level2">
<h2>Data In</h2>
<p>The first piece of data we need is the geo-coded version of the police reports dataset that Google Maps and I made in <a href="/posts/drug-crime-analysis-with-library-sf.html">my last post</a>. You can download the csv file locally or use the <code>raw.githubusercontent.com</code> domain to download directly via URL from Github.</p>
<pre class="r"><code>crime &lt;- read_csv(&quot;https://raw.githubusercontent.com/NathanCDay/cville_crime/master/crime_geocode.csv&quot;)

crime %&lt;&gt;% filter(complete.cases(crime)) # not all of the records could be geo-coded

names(crime) %&lt;&gt;% tolower() # easy typing</code></pre>
<p>In case you missed the last post, geo-coding and manual data entry are both messy businesses. Not every address in the police reports can be accurately geocoded, but in the name of transparency my geo-coded version retains these missed locations to match the original.</p>
<p>The second data piece we need is the <a href="http://opendata.charlottesville.org/datasets/us-census-block-group-area-2010">2010 US Census Block Group Areas</a> for Charlottesville, Virginia, to filter the crime report locations to keep only those within the city limits. I am using <code>library(geojsonio)</code> to grab this data directly from the <a href="/posts.">ODP’s API</a>.</p>
<pre class="r"><code>census &lt;- geojson_read(&quot;https://opendata.arcgis.com/datasets/e60c072dbb734454a849d21d3814cc5a_14.geojson&quot;,
                       what = &quot;sp&quot;) # a Spatial object (list)

census %&lt;&gt;% st_as_sf() # convert to sf

names(census) %&lt;&gt;% tolower()

census %&lt;&gt;% select(objectid, area = area_, population, geometry) # keep only a few variables</code></pre>
<p>In spatial analysis, coordinate referense systems (CRS) are critical when working with multiple data sources. It is required that the CRS values match to perform any sort of spatial computations between objects. Since <code>census</code> was downloaded as geoJSON data, it already has a CRS assigned. We will use that for the setting the CRS of <code>crime</code>.</p>
<pre class="r"><code>crs_val &lt;- st_crs(census, asText = TRUE) # returns CRS as chr

crime %&lt;&gt;% st_as_sf(coords = c(&quot;lon&quot;, &quot;lat&quot;), # define coordinate variables
                    crs = crs_val) # set CRS to match census</code></pre>
</div>
<div id="spatial-viz" class="section level2">
<h2>Spatial viz</h2>
<p>Maybe the second biggest reason to be excited about <code>library(sf)</code> is <code>geom_sf()</code>, which is in the development version of <code>library(ggplot2)</code>. This special geom is designed specifically for plotting <code>sf</code> objects, duh, meaning now we can stay in the land of layers and coninue avoiding <code>plot()</code> like the plauge.</p>
<p>Because plotting ~31,000 points is a lot to plot, let’s look at the data for unique addresses only, which brings us down to ~3,000 points. Remember the addresses in this dataset are only reported to the hundred block level, so we expect to have a lot reports from high frequency blocks.</p>
<pre class="r"><code># install dev ggplot2
library(devtools)</code></pre>
<pre><code>## 
## Attaching package: &#39;devtools&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:geojsonio&#39;:
## 
##     lint</code></pre>
<pre class="r"><code>install_github(&quot;tidyverse/devtools&quot;)</code></pre>
<pre><code>## Downloading GitHub repo tidyverse/devtools@master
## from URL https://api.github.com/repos/tidyverse/devtools/zipball/master</code></pre>
<pre><code>## Installation failed: Not Found (404)</code></pre>
<pre class="r"><code>ggplot(census) +
    geom_sf(data = group_by(crime, address) %&gt;% slice(1), # only unique addresses
            alpha = .1) +
    geom_sf(color = &quot;red&quot;, fill = NA)</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/viz_check,%20fig-1.png" width="672" /></p>
<p>We can see that bulk of the police reports are located within the city limits, but a lot are located just outside in Albemarle County and some reports are far far away. To focus on the crime patterns within the city we want to drop the point outside of the red areas.</p>
</div>
<div id="spatial-fitler" class="section level2">
<h2>Spatial fitler</h2>
<p>We will use the areas from <code>census</code> as overlays to check which <code>crime</code> points fall within each, via <code>st_within()</code>. We want to store the resulting census block id for each observation in <code>crime</code> and drop the observations that don’t overlap. Since this is all with <code>sf</code> objects, we can use good the good old <code>library(dplyr)</code> functions <code>mutate()</code> and <code>filter()</code>, to make it happen.</p>
<pre class="r"><code># add a new column to show which census block group each point resides in
crime %&lt;&gt;% mutate(within = st_within(crime, census) %&gt;% # returns a list by default
                      as.numeric()) # convert to numeric for mutate()

nrow(crime) # 31888</code></pre>
<pre><code>## [1] 31888</code></pre>
<pre class="r"><code># remove rows with NAs, because they&#39;re outside of the city
crime %&lt;&gt;% filter(!is.na(within))
nrow(crime) # 31034</code></pre>
<pre><code>## [1] 31034</code></pre>
<pre class="r"><code># re-viz
ggplot(census) +
    geom_sf(data = group_by(crime, address) %&gt;% slice(1), # only unique addresses
            alpha = .1) +
    geom_sf(color = &quot;red&quot;, fill = NA)</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/filter_crime-1.png" width="672" /></p>
<p>That looks better, doesn’t it? And we only lost ~800 reports.</p>
<p>Now that we have only the police reports from within the city, let’s take a closer look at the distribution of drug related crime.</p>
</div>
<div id="where-are-the-drugs" class="section level2">
<h2>Where are the drugs?</h2>
<p>In a perfect world all of the drug offenses would have the same tag in <code>crime$offense</code>. But this isn’t DisneyLand so lets use some <code>grepl()</code> to sift out the possible related tags.</p>
<pre class="r"><code># flag drug-related offense tags
crime %&lt;&gt;% mutate(drug_flag = ifelse(grepl(&quot;drug&quot;, offense, ignore.case = TRUE),
                                     &quot;drugs&quot;, &quot;not_drugs&quot;))

# check the &quot;drug-related&quot; tags
filter(crime, drug_flag == &quot;drugs&quot;) %&gt;% with(table(offense))</code></pre>
<pre><code>## offense
##  DRUG AWARENESS PRESENTATION    DRUG EQUIPMENT VIOLATIONS 
##                            1                           26 
##      DRUG/NARCOTIC VIOLATION FEDERAL DRUG CONSPIRACY CASE 
##                         1818                            1 
##         MISC CRIMINAL - DRUG 
##                            1</code></pre>
<p>Those offense tags all seem to be drug related, except “DRUG AWARENESS PRESENTATION”, which doesn’t sound like a criminal report at all. Remember manual data entry is messy business, so let’s just drop the lone “DRUG AWARENESS PRESENTATION” observation and compare the distribution of drug crime and other crime.</p>
<p>Here again we will use some classic <code>tidyverse</code> verbs directly on <code>crime</code>, to construct a summary of total counts for each <code>drug_flag</code> at every address.</p>
<pre class="r"><code>address_summary &lt;- group_by(crime, address) %&gt;%
    summarise(drug_crime = sum(drug_flag == &quot;drugs&quot;),
              other_crime = sum(drug_flag != &quot;drugs&quot;)) %&gt;%
    gather(type, number, contains(&quot;crime&quot;))

# now plot it
ggplot(census) +
    geom_sf() +
    geom_sf(data = address_summary,
            aes(size = number, color = number, alpha = number)) +
    scale_color_viridis() +
    scale_size_area(max_size = 10) +
    facet_grid(~type)</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/address_sum-1.png" width="672" /></p>
<p>It looks like there is a concentration of crime in the downtown area, which makes sense since becasue crime rates are typically proportional to population/business density. However one address downtown stands out as much more frequent that the rest, let’s investigate what’s going on there.</p>
<pre class="r"><code>arrange(address_summary, -number) %&gt;% head() # 600 E Market St</code></pre>
<pre><code>## Simple feature collection with 6 features and 3 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -78.50007 ymin: 38.01713 xmax: -78.47746 ymax: 38.05137
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
## # A tibble: 6 x 4
##                               address        type number          geometry
##                                 &lt;chr&gt;       &lt;chr&gt;  &lt;int&gt;  &lt;simple_feature&gt;
## 1  600 E MARKET ST Charlottesville VA other_crime    635 &lt;POINT (-78.4...&gt;
## 2 700 PROSPECT AVE Charlottesville VA other_crime    412 &lt;POINT (-78.4...&gt;
## 3  600 E MARKET ST Charlottesville VA  drug_crime    410 &lt;POINT (-78.4...&gt;
## 4   1100 5TH ST SW Charlottesville VA other_crime    341 &lt;POINT (-78.4...&gt;
## 5  1100 EMMET ST N Charlottesville VA other_crime    307 &lt;POINT (-78.5...&gt;
## 6   400 GARRETT ST Charlottesville VA other_crime    303 &lt;POINT (-78.4...&gt;</code></pre>
<p>Something is going on there. I don’t think it’s a coicidence, that the police station is located at 606 E Market St Perhaps it has something to do with the departments reporting practices, but I really doubt most crimes are being commited a stone’s throw from the popo.</p>
<p>Perhaps we can learn something more by looking at the proportion of crimes reported at 600 E Market for each type of <code>drug_flag</code>.</p>
<pre class="r"><code>station_props &lt;- arrange(address_summary, -number) %&gt;%
    group_by(type) %&gt;%
    add_count(wt = number) %&gt;%
    slice(1)

summarise(station_props, prop_total = number / n)</code></pre>
<pre><code>## # A tibble: 2 x 2
##          type prop_total
##         &lt;chr&gt;      &lt;dbl&gt;
## 1  drug_crime 0.22198159
## 2 other_crime 0.02175626</code></pre>
<pre class="r"><code>with(station_props, prop.test(number, n))</code></pre>
<pre><code>## 
##  2-sample test for equality of proportions with continuity
##  correction
## 
## data:  number out of n
## X-squared = 2134, df = 1, p-value &lt; 2.2e-16
## alternative hypothesis: two.sided
## 95 percent confidence interval:
##  0.1809112 0.2195395
## sample estimates:
##     prop 1     prop 2 
## 0.22198159 0.02175626</code></pre>
<p>The relative proportion of drug crime reported at the police station is much higher than that for other crimes. It’s quite possible that I’ve been watching to many crime/justice documentaries on Netflix, but I really hope there is solid reason for this disproportinate hotspot, and it’s not something more. Going forward I’ll drop the reports from 600 E Market so they don’t cloud our anlysis.</p>
</div>
<div id="hot-blocks" class="section level2">
<h2>Hot blocks</h2>
<p>Crime tends to cluster and typically in the most urban areas, i.e. the places with the densest populations and the densest targets. Often just a single address or block is responsible for the majority of crime reported, this is called a “hot spot”. Becasue of this patternm, simply using total counts to find areas of of high criminal acivity, is not particularly useful.</p>
<p>So we need a normalization factor. Normalizing to the total number of crimes reported will let us calculate the proportion of drug crime, which is a more useful measuring stick.</p>
<pre class="r"><code># drop the police station to look at spatial trends in the community
crime %&lt;&gt;% filter(address != &quot;600 E MARKET ST Charlottesville VA&quot;)

# summarise counts by census block
crime_sum &lt;- st_set_geometry(crime, NULL) %&gt;% # need to remove geometry property
    group_by(within, drug_flag) %&gt;%
    count() %&gt;%
    spread(drug_flag, n) %&gt;% rowwise() %&gt;%
    mutate(total = sum(drugs, not_drugs),
           frac_drugs = drugs / total)

# join rate info into census
census %&lt;&gt;% inner_join(crime_sum, by = c(&quot;objectid&quot; = &quot;within&quot;))</code></pre>
<p>Now that we have our count data summarrized, let’s plot it, three different ways. Looking at the number of total crime crime reports, total drug crime reports and the fraction of drug crime reports in each census block group:</p>
<pre class="r"><code>plot_list &lt;- list()

plot_list[[&quot;total&quot;]] &lt;- ggplot(census) +
    geom_sf(aes(fill = total)) +
    scale_fill_viridis()

plot_list[[&quot;drugs&quot;]] &lt;- ggplot(census) +
    geom_sf(aes(fill = drugs)) +
    scale_fill_viridis()

plot_list[[&quot;frac&quot;]] &lt;- ggplot(census) +
    geom_sf(aes(fill = frac_drugs)) +
    scale_fill_viridis()

cowplot::plot_grid(cowplot::plot_grid(plotlist = plot_list[1:2]), plot_list[[3]], nrow = 2)</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/census_heat,%20fig-1.png" width="672" /></p>
<p>The total reports and total drug reports plots show similar stories, with the downtown mall area being the most frequent census block for reports. You can see how totals aren’t the most useful metric.</p>
<p>Once we plot the fraction of drug crimes, we see a new pattern. Two census block groups where almost 10% of the crime is drug related. In order to get a better idea of what streets are included in each census block, we can replot the last “frac_drugs” plot as an interactive <code>leaflet</code> map, so we can zoom in and to get a better view.</p>
<pre class="r"><code>library(leaflet)

fill_pal &lt;- pal &lt;- colorNumeric(&quot;viridis&quot;, domain = census$frac_drugs)

leaflet(census, options = leafletOptions(minZoom = 12, max_zoom = 16)) %&gt;%
    addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
    addPolygons(color = ~fill_pal(frac_drugs), fillOpacity = .5,
                popup = ~paste0(&quot;drugs: &quot;, drugs, &quot;&lt;br&gt;&quot;,
                                &quot;total: &quot;, total)) %&gt;%
    widgetframe::frameWidget(height = &#39;400&#39;) # containerizes widgets so CSS properties don&#39;t interfer with page CSS</code></pre>
<div id="htmlwidget-1" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html//widgets/widget_unnamed-chunk-4.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>The two hot census blocks, are located along Cherry Avenue and 5th Street SW, just south of downtown. These adjacent areas are home to two of Charlottesville’s largest Section 9 housing developments and are likely some of the lowest income areas of the city.</p>
<p>I have a follow up post planned for using <a href="https://www.census.gov/programs-surveys/acs/">American Community Survey data</a> to expand on this idea and actualy get data to quanitfy this hypothesis that low-income area have more drug crime. Exploring quanifiable risk factors is key to using data to creating safer communities.</p>
</div>
<div id="hot-grid" class="section level2">
<h2>Hot grid</h2>
<p>Suppose we want to get an idea of hot spots on a smaller scale. Instead of using the census block areas, we can construct a grid of our own, with <code>st_make_grid()</code>. The masking/point inclusion process is the same, just with new shapes. First let’s make out grid and overlay it on top of the census areas</p>
<pre class="r"><code>grd &lt;- st_make_grid(census, n = 25) %&gt;% st_sf() # 25x25 evenly sized squares

ggplot(census) +
    geom_sf(color = &quot;red&quot;) +
    geom_sf(data = grd, fill = NA) +
    coord_sf(crs = st_crs(census), datum = NA) # remove grid lines</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/make_grid,%20message%20-%20FALSE-1.png" width="672" /></p>
<p>Boom done.</p>
<p>The inital grid fills the entire bounding box, i.e. the smallest rectangle that encompases the entire census map. This makes for a lot of grid squares that won’t have any data. Let’s remove the squares, whose area doesn’t intersect with the area of the census blocks.</p>
<pre class="r"><code>grd %&lt;&gt;% st_intersection(st_geometry(st_union(census))) # filter to those in census

ggplot(census) +
    geom_sf(color = &quot;red&quot;) +
    geom_sf(data = grd, fill = NA) +
    coord_sf(crs = st_crs(census), datum = NA) # remove grid lines</code></pre>
<p><img src="/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>The helper functions for pairwise geometry comparisons, like <code>st_within()</code> and <code>st_intersection()</code> are another nice perk of a <code>libary(sf)</code> workflow. Instead of multiple lines with <code>library(sp)</code> now it’s just one!</p>
<p>All that’s left now is to caluculate the number of points within each square, and summarise them by drug related and total reports just like we did before.</p>
<pre class="r"><code>crime$grd &lt;- st_within(crime, grd) %&gt;% as.numeric()

grd_sum &lt;- st_set_geometry(crime, NULL) %&gt;% # need to remove geometry property
    group_by(grd, drug_flag) %&gt;%
    count() %&gt;%
    spread(drug_flag, n) %&gt;% rowwise() %&gt;%
    mutate(drugs = ifelse(is.na(drugs), 0, drugs), # some areas don&#39;t have drug related crime, recode from NA to 0
           total = sum(drugs, not_drugs, na.rm = TRUE),
           frac_drugs = drugs / total)

# join sumamry stats back into grd
grd %&lt;&gt;% set_names(&quot;geometry&quot;) %&gt;% # sf functions look for geometry column
    mutate(grd = 1:nrow(.)) %&gt;% # make a key to match back on
    full_join(grd_sum)</code></pre>
<p>We did a little extra processing here than earlier, because as we moved to smaller summary areas, we introduced some areas without data (no crime reports). To imporove our visualiation, we recoded the ares with no drug crime from missing values to zeros. The area wihtout any crime reported are still treated as NAs.</p>
<pre class="r"><code>bins &lt;- c(0, .05, .1, .15, 1) # set custom bin breaks
grd_pal &lt;- pal &lt;- colorBin(&quot;viridis&quot;, domain = grd$frac_drugs, bins = bins) # important to rescale

leaflet(grd, options = leafletOptions(minZoom = 12, max_zoom = 16)) %&gt;%
    addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
    addPolygons(data = census, fill = NA, color = &quot;black&quot;, weight = 1) %&gt;%
    addPolygons(color = ~grd_pal(frac_drugs), stroke = FALSE, fillOpacity = .75,
                popup = ~paste0(&quot;drugs: &quot;, drugs, &quot;&lt;br&gt;&quot;,
                                &quot;total: &quot;, total)) %&gt;%
    addLegend(pal = grd_pal, values = ~frac_drugs, opacity = .7, title = NULL,
              position = &quot;bottomright&quot;, na.label = &quot;no crimes&quot;) %&gt;%
    widgetframe::frameWidget(height = &#39;400&#39;)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"url":"/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html//widgets/widget_leaf_frac.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>Clicking on a given grid square will show the break down of crimes reported there. We can see several of the highlighted hot spots have very low numbers of total reports, making their fraction of drug related offenses much higher. Still we see a band of blue and green squares to the south-west of downtown, in the same hot census blocks.</p>
<p>Now that we are looking at smaller areas, let’s remake the plot above but instead of using the fraction of drug related crime, go back to using just total drug reports to see where the highest volume areas are.</p>
<pre class="r"><code>bins2 &lt;- c(0, 10, 25, 50, Inf)
grd_pal2 &lt;- colorBin(&quot;viridis&quot;, domain = grd$drugs, bins = bins2)

leaflet(grd, options = leafletOptions(minZoom = 12, max_zoom = 16)) %&gt;%
    addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
    addPolygons(data = census, fill = NA, color = &quot;black&quot;, weight = 1) %&gt;%
    addPolygons(color = ~grd_pal2(drugs), stroke = FALSE, fillOpacity = .75,
                popup = ~paste0(&quot;drugs: &quot;, drugs, &quot;&lt;br&gt;&quot;,
                                &quot;total: &quot;, total)) %&gt;%
    addLegend(pal = grd_pal2, values = ~frac_drugs, opacity = .7, title = NULL,
              position = &quot;bottomright&quot;, na.label = &quot;no crimes&quot;) %&gt;%
    widgetframe::frameWidget(height = &#39;400&#39;)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"url":"/post/2017-12-18-drug-crime-analysis-with-library-sf_files/figure-html//widgets/widget_leaf_drugs.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>Using totals instead, highlights the hottest (yellow) spots as around the downtown mall. Other noteable hotter spots (green) cover areas near IX and Tonsler parks, both of those have large numbers of total reports. The lone green grid on the north side of the city, covers Charlottesville High School and no residental streets. There were 25 drug crimes reported there among 306 total crimes, making it one of the most frequent spots for criminal activity. Charlottesville’s reputatation for public school to prison pipeline, might have some data to back it up.</p>
</div>
<div id="wrap-up" class="section level2">
<h2>Wrap up</h2>
<p>I hope this was a easy to follow use case for spatial anlysis with <code>library(sf)</code>. I think it make a lot of the spatial manipulation simpler than before and it plays nicely with the <code>tidyverse</code>. It’s integration isn’t seemless yet, there are still some friction points, but I am excited to see it mature.</p>
<p>If you liked this sort of stuff, come out to the Smart Cville meetup in February and get your hands coding. If you have any feedback on this project or other ideas where data might be able to help Cville, let me know. Cheers!</p>
</div>
