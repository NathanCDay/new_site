---
title: 'cpdcrimedata: A R package of police reports'
author: Nate Day
date: '2018-08-04'
slug: cpdcrimedata-a-r-package-of-police-reports
categories:
  - Civic Data
tags:
  - devtools
  - packages
  - datasets
draft: true
---



<p>I’ve also been working on a data package that contains Charlottesville’s police reports for the last 5 years, so I’m going to use that here to make these maps community relevant.</p>
<pre class="r"><code># devtools::install_github(&quot;nathancday/cpdcrimedata&quot;)
library(cpdcrimedata)

library(sf)</code></pre>
<pre><code>## Linking to GEOS 3.6.1, GDAL 2.1.3, proj.4 4.9.3</code></pre>
<pre class="r"><code>library(magrittr)
library(tidyverse)</code></pre>
<pre><code>## ── Attaching packages ──────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.0.0     ✔ purrr   0.2.5
## ✔ tibble  1.4.2     ✔ dplyr   0.7.6
## ✔ tidyr   0.8.1     ✔ stringr 1.3.1
## ✔ readr   1.1.1     ✔ forcats 0.3.0</code></pre>
<pre><code>## Warning: package &#39;dplyr&#39; was built under R version 3.5.1</code></pre>
<pre><code>## ── Conflicts ─────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ tidyr::extract()   masks magrittr::extract()
## ✖ dplyr::filter()    masks stats::filter()
## ✖ dplyr::lag()       masks stats::lag()
## ✖ purrr::set_names() masks magrittr::set_names()</code></pre>
<p>The <code>cpdcrimedata</code> package has one main data set <code>crime</code>, which is the publically available police reports that I geocoded with GoogleMaps. This is a living data set that gets updated periodically and the raw version is available on the city’s <a href="http://opendata.charlottesville.org/">Open Data Portal</a>.</p>
<pre class="r"><code>head(crime)</code></pre>
<pre><code>##   RecordID             Offense   IncidentID BlockNumber        StreetName
## 1    30967         Hit and Run 201800021284         500           PARK ST
## 2    30969 Larceny - All Other 201800021292         700         WALKER SQ
## 3    30970 Motor Vehicle Theft 201800021299        1100         W MAIN ST
## 4    30971 Larceny - All Other 201800021302         700         WALKER SQ
## 5    30972         Hit and Run 201800021308        1200          EMMET ST
## 6    30973           Vandalism 201800021357         200 RIDGE MCINTIRE RD
##   Agency DateReported HourReported
## 1    CPD   2018-07-19         0143
## 2    CPD   2018-07-19         0623
## 3    CPD   2018-07-19         1029
## 4    CPD   2018-07-19         1119
## 5    CPD   2018-07-19         1232
## 6    CPD   2018-07-19         2208
##                                    address      lat       lon
## 1           500 PARK ST Charlottesville VA 38.03319 -78.47568
## 2         700 WALKER SQ Charlottesville VA 38.03060 -78.49226
## 3        1100 W MAIN ST Charlottesville VA 38.03262 -78.49633
## 4         700 WALKER SQ Charlottesville VA 38.03060 -78.49226
## 5         1200 EMMET ST Charlottesville VA 38.05283 -78.49847
## 6 200 RIDGE MCINTIRE RD Charlottesville VA 38.03127 -78.48388
##                                       formatted_address           loc_type
## 1           500 Park St, Charlottesville, VA 22902, USA            ROOFTOP
## 2     700 Walker Square, Charlottesville, VA 22903, USA            ROOFTOP
## 3        1100 W Main St, Charlottesville, VA 22903, USA            ROOFTOP
## 4     700 Walker Square, Charlottesville, VA 22903, USA            ROOFTOP
## 5       1200 Emmet St N, Charlottesville, VA 22903, USA            ROOFTOP
## 6 200 Ridge McIntire Rd, Charlottesville, VA 22903, USA RANGE_INTERPOLATED</code></pre>
<pre class="r"><code>nrow(crime)</code></pre>
<pre><code>## [1] 30977</code></pre>
<pre class="r"><code>range(crime$DateReported)</code></pre>
<pre><code>## [1] &quot;2013-07-22 EDT&quot; &quot;2018-07-19 EDT&quot;</code></pre>
<pre class="r"><code>tracts &lt;- sf::read_sf(&quot;https://opendata.arcgis.com/datasets/63f965c73ddf46429befe1132f7f06e2_15.geojson&quot;)

tracts %&lt;&gt;% select(OBJECTID, area = AREA_, Population:Asian)</code></pre>
<p>Then convert <code>crime</code> to a <code>sf</code> object.</p>
<pre class="r"><code>crime %&lt;&gt;%
    filter(complete.cases(.) ) %&gt;% # it keeps all cases, not all cases can be geo-coded
    st_as_sf(coords = c(&quot;lon&quot;, &quot;lat&quot;),
             crs = st_crs(tracts) )</code></pre>
<p>Then filtering the individual points by polygon.</p>
<pre class="r"><code>crime %&lt;&gt;%
    mutate(OBJECTID = st_within(crime, tracts) %&gt;%
                    as.numeric() ) %&gt;%
    filter(!is.na(OBJECTID))</code></pre>
<pre><code>## although coordinates are longitude/latitude, st_within assumes that they are planar</code></pre>
<p>Now we should only have points within the city limits. Using <code>geom_sf()</code> to confirm that:</p>
<pre class="r"><code>crime %&gt;%
    count(formatted_address) %&gt;%
    ggplot() +
        geom_sf(data = tracts) +
        geom_sf(aes(alpha = n, size = n))</code></pre>
<p><img src="/post/2018-08-04-cpdcrimedata-a-r-package-of-police-reports_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
