---
title: 'cpdcrimedata: A R package of police reports'
author: Nate Day
date: '2018-08-04'
slug: cpdcrimedata-a-r-package-of-police-reports
categories:
  - Civic Data
tags:
  - devtools
  - packages
  - datasets
draft: true
---

I've also been working on a data package that contains Charlottesville's police reports for the last 5 years, so I'm going to use that here to make these maps community relevant.

```{r load_out}
# devtools::install_github("nathancday/cpdcrimedata")
library(cpdcrimedata)

library(sf)
library(magrittr)
library(tidyverse)
```

The `cpdcrimedata` package has one main data set `crime`, which is the publically available police reports that I geocoded with GoogleMaps. This is a living data set that gets updated periodically and the raw version is available on the city's [Open Data Portal](http://opendata.charlottesville.org/).

```{r crime_data}
head(crime)
nrow(crime)
range(crime$DateReported)
```

```{r census_sensor}
tracts <- sf::read_sf("https://opendata.arcgis.com/datasets/63f965c73ddf46429befe1132f7f06e2_15.geojson")

tracts %<>% select(OBJECTID, area = AREA_, Population:Asian)
```

Then convert `crime` to a `sf` object.

```{r sf_conversion}
crime %<>%
    filter(complete.cases(.) ) %>% # it keeps all cases, not all cases can be geo-coded
    st_as_sf(coords = c("lon", "lat"),
             crs = st_crs(tracts) )
```

Then filtering the individual points by polygon.

```{r spatial_filter}
crime %<>%
    mutate(OBJECTID = st_within(crime, tracts) %>%
                    as.numeric() ) %>%
    filter(!is.na(OBJECTID))
```

Now we should only have points within the city limits. Using `geom_sf()` to confirm that:

```{r}
crime %>%
    count(formatted_address) %>%
    ggplot() +
        geom_sf(data = tracts) +
        geom_sf(aes(alpha = n, size = n))
```